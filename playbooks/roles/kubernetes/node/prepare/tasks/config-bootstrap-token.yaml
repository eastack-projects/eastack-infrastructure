---
- name: Generate random token id and token secret
  set_fact:
    token_id: "{{ lookup('password', '/dev/null length=6 chars=ascii_letters') | lower }}"
    token_secret: "{{ lookup('password', '/dev/null length=16 chars=ascii_letters') | lower }}"

- name: Copy token.yaml
  template:
    src: token.yaml.j2
    dest: /root/token.yaml
    mode: 0644
  delegate_to: kubernetes-server

- name: Apply token to kubernetes
  shell:
    cmd: kubectl apply -f /root/token.yaml
  delegate_to: kubernetes-server

- name: Slurp vault_int_ca.crt
  slurp:
    src: "{{ VAULT_PKI_DIR }}/{{ INT_CERT_NAME }}"
  register: int_cert
  delegate_to: vault

- name: Generate bootstrap-kubelet.conf
  template:
    src: bootstrap-kubelet.conf.j2
    dest: /etc/kubernetes/bootstrap-kubelet.conf
    mode: 0644
