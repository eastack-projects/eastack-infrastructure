= Infrastructures

Based Ansible and Vagrant.

== Boot Order

vault
bind
etcd
kubernetes-server
kubernetes-node

== IP allocation

bind:: 192.168.33.10
vault:: 192.168.33.20
etcd:: 192.168.33.3[0-9]
harbor:: 192.168.33.40
gitlab:: 192.168.33.50
kubernetes-server:: 192.168.33.60
kubernetes-node:: 192.168.33.7[0-9]

== notes

.test etcd cluster
[source, bash]
----
etcdctl --cacert=ca.crt --cert=client.crt --key=client.key put hello world
----

.coredns deployment
[source, bash]
----
git clone https://github.com/coredns/deployment.git
# 10.96.0.10 在 playbooks/roles/kubernetes/node/setup/templates/kubelet-config.yaml.j2
./deploy.sh -s -i 10.96.0.10 > coredns-deployment.yaml
kubectl replace --force -f coredns-deployment.yaml 
----

.nginx ingress
[source, bash]
----
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.45.0/deploy/static/provider/cloud/deploy.yaml
kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission
----

== To Do

* [x] kubernetes 集群搭建
* [ ] 还有太多细节值得完善
* [ ] clean file
* [ ] github releast 下载可以借助https://ghproxy.com等实现
* [ ] 差个高配服务器,,,,啊
* [ ] 命名与可维护性
* [x] token 是直接生成到服务端和还是先存到本地，需要看有没有其他任务用到
* [x] 都在服务器上好，本地尽可能啥都不存
* [ ] 想上OpenStack然后配合Terraform、Packer、Ansible做到全面IAC。
* [ ] 未来目录等规范向minikube靠拢
* [ ] 创建目录的操作应该和变量声明一样，可能用到前才创建会好一些吧
* [ ] 多个Node使用同一token，会有冲突
* [ ] 一个ROLE只做一件事
* [ ] 每个软件最好都有自己的用户组和用户
* [ ] defaults vs vars
* [ ] allow_any_name
* [ ] 主动注册的形式更加灵活


准备文件

二进制安装

生成证书

修改配置
